
Fluorescence Marker Detection
=============================

This example will help you to build the fluorescence marker detection app for Zion, Banff, Yz01 chips.

Data Preparation for the Fluorescence Marker Detection
======================================================

Fluorescence marker input
-------------------------

- A TIFF file of the raw image from SUMMIT. Its path is specified in `image_path` in the example code.
- A TSV file of marker pattern. Its path is specified in `marker_pattern_path` in the example code. The following are some typical patterns:
  - ZION  (AM1)
    @code
    . . . . . . . . . .
    . . . . . . . . . .
    . . X X . . X X . .
    . . X X . . X X . .
    . . . . X X . . . .
    . . . . X X . . . .
    . . X X . . X X . .
    . . X X . . X X . .
    . . . . . . . . . .
    . . . . . . . . . .
    @endcode
  - ZION  (AM3)
    @code
    . . . . . . . . . .
    . . . . . . . . . .
    . . . . X X . . . .
    . . . . X X . . . .
    . . X X . . X X . .
    . . X X . . X X . .
    . . . . X X . . . .
    . . . . X X . . . .
    . . . . . . . . . .
    . . . . . . . . . .
    @endcode
  - Banff (AM1)
    @code
    . . . . . . . . . .
    . X X X . . X X X .
    . X . . . . . . X .
    . X . . . . . . X .
    . . . . . . . . . .
    . . . . . . . . . .
    . X . . . . . . X .
    . X . . . . . . X .
    . X X X . . X X X .
    . . . . . . . . . .
    @endcode
  - Banff (AM3)
    @code
    . . . . . . . . . .
    . . . . X X . . . .
    . . . . . . . . . .
    . . . . . . . . . .
    . X . . . . . . X .
    . X . . . . . . X .
    . . . . . . . . . .
    . . . . . . . . . .
    . . . . X X . . . .
    . . . . . . . . . .
    @endcode
  - YZ01  (AM1)
    @code
    . . . . . . . . . .
    . X X X . . X X X .
    . X . . . . . . X .
    . X . . . . . . X .
    . . . . . . . . . .
    . . . . . . . . . .
    . X . . . . . . X .
    . X . . . . . . X .
    . X X X . . X X X .
    . . . . . . . . . .
    @endcode
  - YZ01  (AM3)
    @code
    . . . . . . . . . .
    . . . . X X . . . .
    . . . . . . . . . .
    . . . . . . . . . .
    . X . . . . . . X .
    . X . . . . . . X .
    . . . . . . . . . .
    . . . . . . . . . .
    . . . . X X . . . .
    . . . . . . . . . .
    @endcode

Fluorescence marker output
--------------------------

- A Rotated image with gridded-line.

Fluorescence marker example
---------------------------

@snippet Example/image_rotation_and_gridding.cpp image_data_preparation

Parameters
----------

- Marker:
    The Marker pattern loaded from tsv marker pattern file. It is generated by the `chipimgproc::marker::Loader::from_txt()` function.
- Mask:
    The Marker mask pattern loaded from tsv marker pattern file which masks bits for marker detection. It is generated by the `chipimgproc::marker::Loader::from_txt()` function.
- Height (µm) of cell:
    The height (µm) of one cell (a probe).
- Width (µm) of cell:
    The width (µm) of one cell (a probe).
- Spacing (µm) of cell:
    The distance (µm) between cell and cell (a probe and a probe). The white part between two cells in the figure 6.
    
    @image html aruco-single-mk-spec.png width=540px
    @image latex aruco-single-mk-spec.png width=13cm
    Figure 6 Marker Pattern Description and Corresponding Auxiliary Parameters for Recognition. (A cell is equivalent to a bit here.)

- Row number of markers:
    Number of markers in one row.
- Column number of markers:
    Number of markers in one column.
- Spacing x of marker:
    The spacing (cell counts) between first top-left cell (probe) of each marker along X axis. It is illustrated in the figure 8.
- Spacing y of marker:
    The spacing (cell counts) between first top-left cell (probe) of each marker along Y axis. It is illustrated in the figure 8.

    @image html spacing-of-markers.png width=540px
    @image latex spacing-of-markers.png width=13cm
    Figure 8 Spacing between Markers.

- µm to pixel:
    The value which is given by manufacturer corresponding to the reader (SUMMIT) hardware, this parameter is used to convert the µm to pixel. (See the table below (Parameters for different camera lens))

Parameters for different chips
------------------------------

|  Parameters  | Zion | Banff | Yz01 |
|:------------:|:----:|:-----:|:----:|
| Height (µm) of cell | 9 | 4 | 3 |
| Width (µm) of cell | 9 | 4 | 3 |
| Spacing (µm) of cell | 2 | 1 | 1 |
| Row number of marker | 3 | 3 | 3 |
| Column number of marker | 3 | 3 | 3 |
| Spacing x of marker | 37 | 81 | 101 |
| Spacing y of marker | 37 | 81 | 101 |

Parameters for different camera lens (See chiplog)
-------------------------------

| Camera Lens | Small Lens | Big Lens |
|:-----------:|:----------:|:--------:|
| µm to pixel |    2.68    |  2.4145  |

- If you do not know the spec for the lens of the camera, see the chiplog.

Marker Detection
================

Marker detection input
----------------------

1. A raw chip image (The raw image from SUMMIT) loaded by OpenCV.
2. A marker layout object generated by `chipimgproc::marker::make_single_pattern_reg_mat_layout()` function.
3. Marker detection with pixel unit (`chipimgproc::MatUnit::PX`) or cell unit (`chipimgproc::MatUnit::CELL`).
4. An integral specifying perfect marker pattern mode. Default mode is to use perfect marker pattern, that is, the marker pattern we set should perfectly match the chip image, set as 0.
5. A logger - Log output.

Marker detection output
-----------------------

1. A marker region object.

Marker detection example
------------------------

@snippet Example/image_rotation_and_gridding.cpp marker_detection
